<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Katheryne Viewer</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif&display=swap" rel="stylesheet" />
  <style>
    body { margin:0; overflow:hidden; font-family:'Noto Serif', serif; }
    canvas { display:block; }
    #loading, #error, #dialog {
      position:absolute; left:50%; transform:translateX(-50%);
      z-index:10; text-align:center;
    }
    #loading {
      top:50%; color:#fff; background:rgba(0,0,0,0.7);
      padding:20px;border-radius:10px;
    }
    #error {
      top:0; width:100%; padding:20px;
      background:#f44336; color:#fff; display:none;
    }
    #dialog {
      bottom:40px; width:60%; max-width:600px; padding:15px 25px;
      background:rgba(0,0,0,0.85); color:#fff;
      border:1px solid rgba(255,215,0,0.5);
      border-radius:10px; font-size:18px; display:none;
      box-shadow: 0 0 15px rgba(255,215,0,0.3);
    }
    .dialog-title {
      color: gold;
      font-weight: bold;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 20px;
      border-bottom: 1px solid rgba(255,215,0,0.3);
      padding-bottom: 5px;
    }
    .dialog-content {
      line-height: 1.5;
    }
    .dialog-icon {
      position: absolute;
      right: 15px;
      top: 15px;
      width: 30px;
      height: 30px;
      background: gold;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="loading">Initializing viewer...</div>
  <div id="error"></div>
  <div id="dialog">
    <div class="dialog-title">Katheryne</div>
    <div class="dialog-content">Ad astra abyssosque...</div>
    <div class="dialog-icon">!</div>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "tween.js": "https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.esm.js"
    }
  }
  </script>

  <script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import * as TWEEN from 'tween.js';

  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const dialog = document.getElementById('dialog');

  // Performance optimization flags
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  const useShadows = !isMobile;
  const shadowQuality = isMobile ? 512 : 1024;

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222222);

  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 15, 5);

  // Optimized renderer settings
  const renderer = new THREE.WebGLRenderer({
    antialias: true,
    powerPreference: "high-performance"
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = useShadows;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.physicallyCorrectLights = true;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.5;
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.maxPolarAngle = Math.PI * 0.9;

  // Ambient light (subtle warm fill)
  const ambientLight = new THREE.AmbientLight(0xfff4e6, 0.25);
  scene.add(ambientLight);

  // All 13 lights with exact Blender coordinates
  const lights = [
    // Right wall main
    { pos: [8.31998, 5.4, 2.92], intensity: 1.8, color: 0xffddb3, distance: 14, decay: 1.8 },
    
    // Right wall accent
    { pos: [9.21, 5.98, 3.32], intensity: 1.5, color: 0xffe6c3, distance: 12, decay: 1.8 },
    
    // High ceiling right
    { pos: [4.00624, 14.17, 4.96998], intensity: 1.2, color: 0xffe6b3, distance: 18, decay: 1.5 },
    
    // High ceiling left
    { pos: [-4.02, 14.16, 5.01998], intensity: 1.2, color: 0xffe6b3, distance: 18, decay: 1.5 },
    
    // Left wall main
    { pos: [-9.18, 5.99001, 3.27], intensity: 1.8, color: 0xffddb3, distance: 14, decay: 1.8 },
    
    // Left wall upper
    { pos: [-9.18, 8.98, 3.27], intensity: 1.4, color: 0xffe6c3, distance: 12, decay: 1.8 },
    
    // Rear high right
    { pos: [4.00624, -14.19, 5.00998], intensity: 1.0, color: 0xffe0b0, distance: 20, decay: 1.5 },
    
    // Rear high left
    { pos: [-3.94999, -14.19, 5.00998], intensity: 1.0, color: 0xffe0b0, distance: 20, decay: 1.5 },
    
    // Left wall lower
    { pos: [-9.18, -5.99, 3.27], intensity: 1.4, color: 0xffddaa, distance: 14, decay: 1.8 },
    
    // Left wall corner
    { pos: [-9.18, -9.01, 3.27], intensity: 1.6, color: 0xffe6c3, distance: 10, decay: 1.8 },
    
    // Right wall lower
    { pos: [9.18, -5.98, 3.22], intensity: 1.4, color: 0xffddaa, distance: 14, decay: 1.8 },
    
    // Right wall corner
    { pos: [9.18, -9.01, 3.21], intensity: 1.6, color: 0xffe6c3, distance: 10, decay: 1.8 },
    
    // Central chandelier
    { pos: [0, -6, 12], intensity: 2.5, color: 0xfff0d0, distance: 22, decay: 1.2 }
  ];

  // Create all lights with optimized settings
  lights.forEach(lightConfig => {
    const light = new THREE.PointLight(
      lightConfig.color,
      lightConfig.intensity,
      lightConfig.distance,
      lightConfig.decay
    );
    light.position.set(...lightConfig.pos);
    
    if (useShadows) {
      light.castShadow = true;
      light.shadow.mapSize.width = shadowQuality;
      light.shadow.mapSize.height = shadowQuality;
      light.shadow.bias = -0.001;
      light.shadow.normalBias = 0.05;
    }
    
    scene.add(light);
  });

  // Enhanced spotlight for Katheryne
  const kathLight = new THREE.SpotLight(0xffd700, 3.5, 10, Math.PI/5, 0.4);
  kathLight.position.set(0, 3.5, -10);
  kathLight.target.position.set(0, 0.14, -12.1);
  if (useShadows) {
    kathLight.castShadow = true;
    kathLight.shadow.mapSize.width = shadowQuality;
    kathLight.shadow.mapSize.height = shadowQuality;
    kathLight.shadow.bias = -0.001;
    kathLight.shadow.normalBias = 0.05;
  }
  scene.add(kathLight);
  scene.add(kathLight.target);

  // Rim light for better character visibility
  const rimLight = new THREE.DirectionalLight(0xfff5e6, 0.8);
  rimLight.position.set(0.5, 0.5, 1);
  scene.add(rimLight);

  const loader = new GLTFLoader();
  const mp3Name = encodeURI("506064546_30055791174065285_2686737457664994031_n (1).mp3");
  const voice = new Audio(`/KATprojects/${mp3Name}`);

  let kath = null;
  let mapScene = null;
  const raycaster = new THREE.Raycaster();
  const mouse = new THREE.Vector2();
  let isAnimating = false;

  // Model optimization function
  function optimizeModel(model) {
    model.traverse(child => {
      if (child.isMesh) {
        child.castShadow = useShadows;
        child.receiveShadow = useShadows;
        
        if (child.material) {
          child.material.roughness = 0.7;
          child.material.metalness = 0.2;
          
          if (isMobile) {
            child.material.aoMapIntensity = 0.5;
            child.material.envMapIntensity = 0.5;
          }
        }
      }
    });
  }

  loader.load('/KATprojects/map.glb',
    map => {
      mapScene = map.scene;
      optimizeModel(mapScene);
      scene.add(mapScene);
    },
    undefined,
    err => {
      error.style.display = 'block';
      error.textContent = 'Failed to load map: ' + err.message;
      loading.style.display = 'none';
    });

  loader.load('/KATprojects/katheryne.glb',
    gltf => {
      kath = gltf.scene;
      kath.position.set(0, 0.140886, -12.1018);
      optimizeModel(kath);
      scene.add(kath);
      loading.style.display = 'none';

      controls.target.copy(kath.position);
      camera.position.set(0, kath.position.y + 1.5, kath.position.z + 3);
      controls.update();
    },
    xhr => {
      loading.textContent = `Loadingâ€¦ ${(xhr.loaded/xhr.total*100).toFixed(2)}%`;
    },
    err => {
      error.style.display = 'block';
      error.textContent = 'Failed to load Katheryne: ' + err.message;
      loading.style.display = 'none';
    });

  function animateCameraToDialogPosition() {
    if (!kath || isAnimating) return;
    
    isAnimating = true;
    controls.enabled = false;
    
    const originalPosition = camera.position.clone();
    const originalTarget = controls.target.clone();
    
    const dialogPosition = new THREE.Vector3(
      kath.position.x - 0.5,
      kath.position.y + 1.2,
      kath.position.z + 1.5
    );
    
    const positionTween = new TWEEN.Tween(originalPosition)
      .to(dialogPosition, 1000)
      .easing(TWEEN.Easing.Quadratic.InOut)
      .onUpdate(() => {
        camera.position.copy(originalPosition);
      })
      .start();
    
    const targetTween = new TWEEN.Tween(originalTarget)
      .to(new THREE.Vector3(
        kath.position.x,
        kath.position.y + 0.5,
        kath.position.z
      ), 1000)
      .easing(TWEEN.Easing.Quadratic.InOut)
      .onUpdate(() => {
        controls.target.copy(originalTarget);
      })
      .start();
    
    dialog.style.display = 'block';
    voice.currentTime = 0;
    voice.play();
    
    setTimeout(() => {
      const returnPositionTween = new TWEEN.Tween(camera.position)
        .to(originalPosition, 1000)
        .easing(TWEEN.Easing.Quadratic.InOut)
        .start();
      
      const returnTargetTween = new TWEEN.Tween(controls.target)
        .to(originalTarget, 1000)
        .easing(TWEEN.Easing.Quadratic.InOut)
        .onComplete(() => {
          controls.enabled = true;
          isAnimating = false;
        })
        .start();
      
      dialog.style.display = 'none';
    }, 3500);
  }

  window.addEventListener('click', e => {
    if (!kath || isAnimating) return;
    
    mouse.x = (e.clientX/window.innerWidth)*2 - 1;
    mouse.y = -(e.clientY/window.innerHeight)*2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObject(kath, true);
    
    if (hits.length) {
      animateCameraToDialogPosition();
    }
  });

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Frame rate optimization
  let lastTime = 0;
  const frameRate = 60;
  const frameInterval = 1000 / frameRate;

  function animate(currentTime) {
    requestAnimationFrame(animate);
    
    const delta = currentTime - lastTime;
    if (delta < frameInterval) return;
    
    TWEEN.update(currentTime);
    controls.update();
    renderer.render(scene, camera);
    
    lastTime = currentTime - (delta % frameInterval);
  }
  
  animate();
  </script>
</body>
</html>