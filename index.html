<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Katheryne Viewer</title>
    <style>
      body { 
        margin: 0; 
        overflow: hidden; 
        font-family: Arial, sans-serif;
      }
      canvas { 
        display: block; 
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background: rgba(0,0,0,0.7);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      #error {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        padding: 20px;
        background: #ff4444;
        color: white;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="loading">Initializing viewer...</div>
    <div id="error"></div>

    <!-- Load Three.js first from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

    <script>
      // Wait for everything to load
      document.addEventListener('DOMContentLoaded', () => {
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        
        try {
          // Verify Three.js is loaded
          if (!window.THREE) {
            throw new Error("Three.js failed to load");
          }
          
          loadingElement.textContent = "Setting up scene...";
          console.log("Three.js version:", THREE.REVISION);

          // Scene setup
          const scene = new THREE.Scene();
          scene.background = new THREE.Color(0x333333);
          
          const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
          const renderer = new THREE.WebGLRenderer({ antialias: true });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.shadowMap.enabled = true;
          document.body.appendChild(renderer.domElement);

          // Lighting
          const ambientLight = new THREE.AmbientLight(0x404040);
          scene.add(ambientLight);

          const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
          directionalLight.position.set(1, 1, 1);
          directionalLight.castShadow = true;
          scene.add(directionalLight);

          // Controls
          const controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.05;
          controls.target.set(0, 1, 0);
          controls.update();

          camera.position.set(0, 1.5, 3);

          // Model loading
          loadingElement.textContent = "Loading model...";
          const loader = new THREE.GLTFLoader();
          const modelPath = window.location.host.includes('github.io') 
            ? '/KATprojects/katheryne.glb' 
            : 'katheryne.glb';
          
          console.log("Attempting to load model from:", modelPath);
          
          loader.load(
            modelPath,
            function (gltf) {
              console.log("Model loaded successfully!");
              scene.add(gltf.scene);
              loadingElement.style.display = 'none';
              
              // Center the model
              const box = new THREE.Box3().setFromObject(gltf.scene);
              const center = box.getCenter(new THREE.Vector3());
              gltf.scene.position.sub(center);
            },
            function (xhr) {
              const percentLoaded = (xhr.loaded / xhr.total * 100).toFixed(2);
              loadingElement.textContent = `Loading model... ${percentLoaded}%`;
              console.log(`${percentLoaded}% loaded`);
            },
            function (error) {
              console.error('Error loading model:', error);
              loadingElement.style.display = 'none';
              
              errorElement.style.display = 'block';
              errorElement.innerHTML = `
                <strong>Error loading model!</strong><br>
                ${error.message}<br><br>
                Tried to load from: ${modelPath}<br>
                Check if: <br>
                - File exists at this path<br>
                - File is not corrupted<br>
                - GitHub has fully processed the file (large files take time)<br>
                - If file >25MB, you need Git LFS
              `;
            }
          );

          // Handle window resize
          window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
          });

          // Animation loop
          function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
          }

          animate();
        } catch (error) {
          console.error("Initialization error:", error);
          loadingElement.style.display = 'none';
          errorElement.style.display = 'block';
          errorElement.innerHTML = `
            <strong>Fatal Error:</strong><br>
            ${error.message}<br><br>
            Possible solutions:<br>
            1. Check your internet connection<br>
            2. Try refreshing the page<br>
            3. The CDN might be down - try again later
          `;
        }
      });
    </script>
  </body>
</html>