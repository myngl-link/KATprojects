<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Katheryne Viewer</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* MAIN VIEWER STYLES */
    body { 
      margin:0; 
      overflow:hidden; 
      font-family:'Roboto', sans-serif; 
      background: #111;
    }
    canvas { display:block; }
    
    /* LOADING OVERLAY */
    #loading-overlay {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:#FFF;
      z-index:1000;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      opacity:1;
      transition: opacity 1s;
    }
    
    #mondstadt-animation {
      width:150px;
      height:150px;
      margin-bottom:30px;
    }
    
    /* ELEMENT LOADING BAR (Updated for .webp) */
    .loading-bar {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 500px;
      height: 62.5px;
      transform: translate(-50%, -50%) scale(0.8);
      user-select: none;
      overflow: hidden;
    }
    
    .loading-bar img {
      position: absolute;
      top: 500px;
      left: 0;
      filter: drop-shadow(0 -500px 0 #f5f5f5);
    }
    
    .loading-bar::after {
      content: "";
      position: absolute;
      top: 500px;
      left: 0;
      filter: drop-shadow(0 -500px 0 #666666);
      width: 500px;
      height: 62.5px;
      background: url("https://raw.githubusercontent.com/myngl-link/KATprojects/main/loading-bar.webp") no-repeat left 100%;
      background-size: 500px 62.5px;
      animation: loading-bar 3.5s cubic-bezier(0.28, 0.11, 0.32, 1) infinite forwards;
    }
    
    @keyframes loading-bar {
      0% { width: 0; background-size: 500px 62.5px; }
      100% { width: 500px; }
    }
    
    @media screen and (max-width: 719px) {
      .loading-bar { display: none; }
      @media screen and (orientation: landscape) {
        .loading-bar { 
          display: block !important; 
          transform: translate(-50%, -50%) scale(0.7) !important; 
        }
      }
    }
    
    /* ERROR OVERLAY */
    #error-overlay {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(255,255,255,0.95);
      z-index:1001;
      display:none;
      justify-content:center;
      align-items:center;
    }
    
    .error-modal {
      width:600px;
      background:white;
      border-radius:3px;
      overflow:hidden;
      box-shadow:0 3px 15px rgba(0,0,0,0.2);
      border:1px solid #E0E0E0;
    }
    
    .error-title {
      background:linear-gradient(to right, #D32F2F, #B71C1C);
      color:white;
      padding:18px;
      text-align:center;
      font-weight:700;
      letter-spacing:0.5px;
      font-size:24px;
    }
    
    .error-body {
      padding:30px 40px;
      line-height:1.6;
      font-size:18px;
      color:#212121;
      text-align:center;
    }
    
    .error-code {
      font-weight:500;
      color:#D32F2F;
      text-align:center;
      margin:20px 0;
      font-size:20px;
    }
    
    #error-confirm {
      display:block;
      width:180px;
      margin:0 auto 30px;
      padding:12px;
      background:#D32F2F;
      color:white;
      border:none;
      border-radius:4px;
      font-weight:500;
      font-size:18px;
      cursor:pointer;
      transition:background 0.2s;
    }
    
    #error-confirm:hover {
      background:#B71C1C;
    }
    
    /* ORIGINAL VIEWER ELEMENTS */
    #error, #dialog {
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      z-index:10;
      text-align:center;
      display:none;
    }
  </style>
</head>
<body>
  <!-- WHITE LOADING OVERLAY -->
  <div id="loading-overlay">
    <!-- Animated Mondstadt Icon -->
    <video id="mondstadt-animation" autoplay loop muted playsinline>
      <source src="https://raw.githubusercontent.com/myngl-link/KATprojects/main/507059009_29906174742360989_5255855171109690292_n.mp4" type="video/mp4">
    </video>
    
    <!-- Element Loading Bar (Updated to .webp) -->
    <div class="loading-bar" role="presentation" aria-hidden="true">
      <img src="https://raw.githubusercontent.com/myngl-link/KATprojects/main/loading-bar.webp" alt="Loading...">
    </div>
  </div>
  
  <!-- ERROR OVERLAY -->
  <div id="error-overlay">
    <div class="error-modal">
      <div class="error-title">System Notification -</div>
      <div class="error-body">
        Data error, please open in a different browser,<br>
        click the three dots from the top right corner<br>
        and click "open in chrome" or any other browser<br>
        you have. Press "Confirm" to copy the URL link<br>
        then paste it to your browser.
      </div>
      <div class="error-code">Error 68-4200</div>
      <button id="error-confirm">Confirm</button>
    </div>
  </div>

  <!-- THREE.JS IMPORTS -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "tween.js": "https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.esm.js"
    }
  }
  </script>

  <!-- MAIN SCRIPT -->
  <script type="module">
    // ======================
    // BROWSER DETECTION
    // ======================
    const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
    const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
    
    if (!isChrome && !isSafari) {
      document.getElementById('error-overlay').style.display = 'flex';
      document.getElementById('loading-overlay').style.display = 'none';
      
      document.getElementById('error-confirm').addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href)
          .then(() => alert('URL copied to clipboard! Please paste it in Chrome or Safari'))
          .catch(() => alert('Please copy this URL manually: ' + window.location.href));
      });
      throw new Error("Incompatible browser");
    }

    // ======================
    // SOUND SYSTEM
    // ======================
    const initSounds = () => {
      const initialSound = new Audio('https://raw.githubusercontent.com/myngl-link/KATprojects/main/loading-sound-effect.mp3');
      const bgMusic = new Audio('https://raw.githubusercontent.com/myngl-link/KATprojects/main/loading-background-music.mp3');
      bgMusic.loop = true;
      
      initialSound.play().then(() => {
        setTimeout(() => bgMusic.play(), 3000);
      }).catch(e => console.error("Sound playback failed:", e));
    };
    
    // Start sounds on first interaction
    document.body.addEventListener('click', initSounds, { once: true });
    document.body.addEventListener('touchstart', initSounds, { once: true });

    // ======================
    // MAIN VIEWER CODE
    // ======================
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import * as TWEEN from 'tween.js';
    
    const loadingOverlay = document.getElementById('loading-overlay');
    const error = document.getElementById('error');
    const dialog = document.getElementById('dialog');

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 15, 5);

    const renderer = new THREE.WebGLRenderer({
      antialias: /Mobi|Android/i.test(navigator.userAgent) ? false : true,
      powerPreference: "high-performance"
    });
    renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1 : window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.maxPolarAngle = Math.PI * 0.9;

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xfff4e6, 0.03);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xfff0d0, 0.2);
    directionalLight.position.set(5, 10, 5);
    scene.add(directionalLight);

    // Load models
    const loader = new GLTFLoader();
    let kath = null;

    loader.load('https://raw.githubusercontent.com/myngl-link/KATprojects/main/katheryne.glb',
      gltf => {
        kath = gltf.scene;
        kath.position.set(0, 0.140886, -12.1018);
        scene.add(kath);
        
        // Hide loading overlay when ready
        setTimeout(() => {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 1000);
        }, 3000);
      },
      undefined,
      err => {
        error.style.display = 'block';
        error.textContent = 'Failed to load Katheryne: ' + err.message;
      });

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      TWEEN.update();
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Handle window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }, false);
  </script>
</body>
</html>