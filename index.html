<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Katheryne Viewer</title>
    <link rel="icon" href="data:,">
    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
      canvas { display: block; }
      #loading {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        color: white; background: rgba(0,0,0,0.7);
        padding: 20px; border-radius: 10px;
        text-align: center;
      }
      #error {
        position: absolute; top: 0; left: 0;
        width: 100%; padding: 20px;
        background: #ff4444; color: white;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="loading">Initializing viewer...</div>
    <div id="error"></div>

    <!-- Using import maps for reliable module resolution -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      // Import with guaranteed resolution
      import * as THREE from 'three';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

      const loadingElement = document.getElementById('loading');
      const errorElement = document.getElementById('error');
      
      try {
        console.log("Three.js successfully loaded:", THREE.REVISION);
        loadingElement.textContent = "Setting up scene...";

        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 1);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.target.set(0, 1, 0);
        controls.update();

        camera.position.set(0, 1.5, 3);

        // Model loading - using absolute path for GitHub Pages
        loadingElement.textContent = "Loading model...";
        const loader = new GLTFLoader();
        const modelPath = '/KATprojects/katheryne.glb';
        
        console.log("Loading model from:", modelPath);
        
        loader.load(
          modelPath,
          (gltf) => {
            console.log("Model loaded successfully!");
            scene.add(gltf.scene);
            loadingElement.style.display = 'none';
            
            // Center model
            const box = new THREE.Box3().setFromObject(gltf.scene);
            const center = box.getCenter(new THREE.Vector3());
            gltf.scene.position.sub(center);
          },
          (xhr) => {
            const percentLoaded = (xhr.loaded / xhr.total * 100).toFixed(2);
            loadingElement.textContent = `Loading model... ${percentLoaded}%`;
            console.log(`${percentLoaded}% loaded`);
          },
          (error) => {
            console.error('Model loading error:', error);
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.innerHTML = `
              <strong>Failed to load model!</strong><br>
              Error: ${error.message}<br><br>
              <strong>Troubleshooting:</strong><br>
              1. Verify <a href="${modelPath}" target="_blank">the model exists</a><br>
              2. Check file size (should be 308KB)<br>
              3. Ensure GitHub has processed the file (wait 5 mins after upload)<br>
              4. Try <a href="https://gltf-viewer.donmccurdy.com/" target="_blank">testing your model here</a>
            `;
          }
        );

        // Handle window resize
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        animate();

      } catch (error) {
        console.error("Initialization failed:", error);
        loadingElement.style.display = 'none';
        errorElement.style.display = 'block';
        errorElement.innerHTML = `
          <strong>Critical Error:</strong><br>
          ${error.message}<br><br>
          <strong>Solutions:</strong><br>
          1. Use Chrome/Firefox/Edge (latest version)<br>
          2. Disable ad-blockers for this page<br>
          3. <button onclick="window.location.reload()">Reload Page</button><br>
          4. <a href="https://github.com/myngl-link/KATprojects" target="_blank">Check repository</a>
        `;
      }
    </script>
  </body>
</html>